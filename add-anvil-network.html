<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·»åŠ  Anvil ç½‘ç»œåˆ° MetaMask</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #1a202c;
            font-size: 28px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }

        .status.info {
            background: #bee3f8;
            color: #2c5282;
        }

        .status.success {
            background: #c6f6d5;
            color: #22543d;
        }

        .status.error {
            background: #fed7d7;
            color: #742a2a;
        }

        .status.warning {
            background: #feebc8;
            color: #7c2d12;
        }

        .network-info {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #718096;
            font-weight: 500;
        }

        .info-value {
            color: #1a202c;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .button {
            width: 100%;
            padding: 16px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .button.primary {
            background: #667eea;
            color: white;
        }

        .button.primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .button.primary:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }

        .button.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .button.secondary:hover {
            background: #cbd5e0;
        }

        .steps {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e2e8f0;
        }

        .steps h3 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .step {
            padding: 12px 0;
            color: #4a5568;
            line-height: 1.6;
        }

        .step strong {
            color: #2d3748;
        }

        .icon {
            display: inline-block;
            margin-right: 8px;
        }

        .footer {
            margin-top: 30px;
            text-align: center;
            color: #718096;
            font-size: 14px;
        }

        .footer a {
            color: #667eea;
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 640px) {
            .container {
                padding: 30px 20px;
            }

            h1 {
                font-size: 24px;
            }

            .info-row {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦Š æ·»åŠ  Anvil ç½‘ç»œ</h1>
        <p class="subtitle">ä¸€é”®æ·»åŠ æœ¬åœ°å¼€å‘ç½‘ç»œåˆ° MetaMask</p>

        <div id="status" class="status info">
            <span class="icon">â„¹ï¸</span>
            <span id="statusText">å‡†å¤‡æ·»åŠ ç½‘ç»œ...</span>
        </div>

        <div class="network-info">
            <div class="info-row">
                <span class="info-label">ç½‘ç»œåç§°</span>
                <span class="info-value">Anvil Local</span>
            </div>
            <div class="info-row">
                <span class="info-label">RPC URL</span>
                <span class="info-value">http://127.0.0.1:8545</span>
            </div>
            <div class="info-row">
                <span class="info-label">Chain ID</span>
                <span class="info-value">31337 (0x7a69)</span>
            </div>
            <div class="info-row">
                <span class="info-label">è´§å¸ç¬¦å·</span>
                <span class="info-value">ETH</span>
            </div>
        </div>

        <button id="addNetworkBtn" class="button primary" onclick="addNetwork()">
            <span class="icon">â•</span>
            æ·»åŠ  Anvil ç½‘ç»œåˆ° MetaMask
        </button>

        <button class="button secondary" onclick="testConnection()">
            <span class="icon">ğŸ”</span>
            æµ‹è¯• Anvil è¿æ¥
        </button>

        <div class="steps">
            <h3>ğŸ“‹ æ‰‹åŠ¨æ·»åŠ æ­¥éª¤</h3>
            <div class="step">
                <strong>1.</strong> æ‰“å¼€ MetaMaskï¼Œç‚¹å‡»é¡¶éƒ¨ç½‘ç»œä¸‹æ‹‰èœå•
            </div>
            <div class="step">
                <strong>2.</strong> ç‚¹å‡»"æ·»åŠ ç½‘ç»œ" â†’ "æ‰‹åŠ¨æ·»åŠ ç½‘ç»œ"
            </div>
            <div class="step">
                <strong>3.</strong> å¡«å†™ä¸Šæ–¹æ˜¾ç¤ºçš„ç½‘ç»œä¿¡æ¯
            </div>
            <div class="step">
                <strong>4.</strong> ç‚¹å‡»"ä¿å­˜"å¹¶åˆ‡æ¢åˆ° Anvil Local ç½‘ç»œ
            </div>
        </div>

        <div class="footer">
            <p>ğŸ“– è¯¦ç»†æ–‡æ¡£: <a href="./docs/METAMASK-ANVIL-CONNECTION-GUIDE.md" target="_blank">MetaMask è¿æ¥æŒ‡å—</a></p>
            <p style="margin-top: 10px;">ğŸš€ Trustless SocialFi - æœ¬åœ°å¼€å‘ç¯å¢ƒ</p>
        </div>
    </div>

    <script>
        // æ£€æŸ¥ MetaMask æ˜¯å¦å®‰è£…
        function checkMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                updateStatus('success', 'âœ… MetaMask å·²å®‰è£…');
                return true;
            } else {
                updateStatus('error', 'âŒ æœªæ£€æµ‹åˆ° MetaMaskï¼Œè¯·å…ˆå®‰è£… MetaMask æ‰©å±•');
                document.getElementById('addNetworkBtn').disabled = true;
                return false;
            }
        }

        // æ›´æ–°çŠ¶æ€ä¿¡æ¯
        function updateStatus(type, text) {
            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            statusDiv.className = `status ${type}`;
            statusText.textContent = text;
        }

        // æ·»åŠ ç½‘ç»œåˆ° MetaMask
        async function addNetwork() {
            if (!checkMetaMask()) return;

            const networkParams = {
                chainId: '0x7a69', // 31337 çš„åå…­è¿›åˆ¶
                chainName: 'Anvil Local',
                nativeCurrency: {
                    name: 'Ether',
                    symbol: 'ETH',
                    decimals: 18
                },
                rpcUrls: ['http://127.0.0.1:8545'],
                blockExplorerUrls: null
            };

            try {
                updateStatus('info', 'â³ æ­£åœ¨æ·»åŠ ç½‘ç»œï¼Œè¯·åœ¨ MetaMask ä¸­ç¡®è®¤...');
                
                await window.ethereum.request({
                    method: 'wallet_addEthereumChain',
                    params: [networkParams]
                });

                updateStatus('success', 'âœ… ç½‘ç»œæ·»åŠ æˆåŠŸï¼MetaMask å·²åˆ‡æ¢åˆ° Anvil Local');
                
                // 3ç§’åæç¤ºå¯ä»¥è®¿é—®åº”ç”¨
                setTimeout(() => {
                    updateStatus('success', 'âœ… ç°åœ¨å¯ä»¥è®¿é—® http://localhost:3000 å¹¶è¿æ¥é’±åŒ…äº†');
                }, 3000);

            } catch (error) {
                console.error('æ·»åŠ ç½‘ç»œå¤±è´¥:', error);
                
                if (error.code === 4902) {
                    updateStatus('error', 'âŒ æ·»åŠ ç½‘ç»œå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ ï¼ˆå‚è€ƒä¸‹æ–¹æ­¥éª¤ï¼‰');
                } else if (error.code === 4001) {
                    updateStatus('warning', 'âš ï¸ ç”¨æˆ·å–æ¶ˆäº†æ“ä½œ');
                } else if (error.code === -32602) {
                    updateStatus('error', 'âŒ ç½‘ç»œå‚æ•°æ— æ•ˆï¼Œè¯·æ£€æŸ¥ Anvil æ˜¯å¦è¿è¡Œ');
                } else {
                    updateStatus('error', `âŒ æ·»åŠ å¤±è´¥: ${error.message}`);
                }
            }
        }

        // æµ‹è¯• Anvil è¿æ¥
        async function testConnection() {
            updateStatus('info', 'â³ æ­£åœ¨æµ‹è¯• Anvil è¿æ¥...');

            try {
                const response = await fetch('http://127.0.0.1:8545', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_chainId',
                        params: [],
                        id: 1
                    })
                });

                if (!response.ok) {
                    throw new Error('HTTP error: ' + response.status);
                }

                const data = await response.json();
                
                if (data.result === '0x7a69') {
                    updateStatus('success', 'âœ… Anvil è¿è¡Œæ­£å¸¸ï¼(Chain ID: 31337)');
                } else {
                    updateStatus('warning', `âš ï¸ æ£€æµ‹åˆ°ä¸åŒçš„ Chain ID: ${data.result}`);
                }

            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                updateStatus('error', 'âŒ æ— æ³•è¿æ¥åˆ° Anvilã€‚è¯·ç¡®ä¿ Anvil æ­£åœ¨è¿è¡Œ (ç«¯å£ 8545)');
                
                // æç¤ºå¦‚ä½•å¯åŠ¨ Anvil
                setTimeout(() => {
                    if (confirm('Anvil ä¼¼ä¹æ²¡æœ‰è¿è¡Œã€‚æ˜¯å¦æŸ¥çœ‹å¯åŠ¨è¯´æ˜ï¼Ÿ')) {
                        alert('åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œ:\n\n./start-dev.sh\n\næˆ–æ‰‹åŠ¨å¯åŠ¨:\n\ncd packages/contracts\nanvil');
                    }
                }, 1000);
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        window.addEventListener('load', () => {
            checkMetaMask();
            
            // è‡ªåŠ¨æµ‹è¯• Anvil è¿æ¥
            setTimeout(testConnection, 500);
        });
    </script>
</body>
</html>

