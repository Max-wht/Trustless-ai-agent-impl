# Requirements

## Functional Requirements（功能需求）

**智能合约层（Solidity + Foundry + Arbitrum）：**

- **FR1：** Agent 注册系统 - Agent 必须能够通过智能合约注册，质押最低数量的原生代币（具体数额由 DAO 治理决定，初始建议 1000 代币），并提供服务端点信息

- **FR2：** VRF 随机 Agent 选择 - 当用户提交内容时，智能合约必须使用 Chainlink VRF 随机选择 5 个 Agent，选择概率基于 Agent 信誉评分加权

- **FR3：** 加权共识投票机制 - 智能合约必须收集 5 个 Agent 的判断结果（通过/拒绝 + 置信度），根据各 Agent 的信誉权重计算最终决策（公式：`最终得分 = Σ(Agent判断 × Agent信誉权重)`，通过阈值 > 0.6 则发布）

- **FR4：** Agent 信誉系统 - 智能合约必须基于历史审核准确率和内容质量反馈动态计算 Agent 信誉评分，公式：`Score = Σ(判断质量 × 时间衰减因子 × 内容质量反馈)`，每日更新

- **FR5：** 时间衰减机制 - 信誉评分必须实现时间衰减（每周衰减 5%），确保近期表现权重大于历史表现

- **FR6：** 质押金罚没机制 - 当 Agent 判断与最终共识严重不符时（连续 10 次错误或单次恶意行为），智能合约必须自动罚没部分或全部质押金

- **FR7：** 内容哈希上链 - 通过审核的内容的 IPFS 哈希值必须记录在智能合约中，确保内容防篡改和永久可访问性

- **FR8：** Agent 判断结果透明化 - 所有 Agent 的判断结果（通过/拒绝、置信度、时间戳）必须记录在链上，用户可查询

- **FR9：** ERC-20 代币合约 - 实现符合 ERC-20 标准的原生代币，总量固定，支持质押、转账、授权功能

- **FR10：** DAO 提案与投票系统 - 智能合约必须支持代币持有者提交提案（修改合规规则）和投票（1 代币 = 1 票），提案通过阈值 > 50%

- **FR11：** 紧急提案快速通道 - 当 > 10% 活跃用户举报某类内容时，自动触发紧急提案，投票窗口 48 小时，通过后规则立即生效

- **FR12：** 用户信誉系统 - 智能合约必须基于用户发布内容的质量（点赞数、评论数、举报率）计算用户信誉评分，信誉影响内容互动的权重

- **FR13：** 用户偏好哈希存储 - 智能合约必须为每个用户存储其加密偏好数据的 IPFS 哈希值，支持更新和查询

**后端服务器层（TypeScript + Node.js）：**

- **FR14：** Agent 审核服务 - 后端必须提供 Agent 审核服务，接收内容提交，调用 OpenAI GPT-4 API 判断是否符合合规规则，返回判断结果和置信度

- **FR15：** 智能合约交互服务 - 后端必须提供与 Arbitrum 智能合约交互的服务，包括读取 Agent 选择结果、提交 Agent 判断、查询信誉评分

- **FR16：** IPFS 内容管理 - 后端必须提供 IPFS 内容上传和检索服务（帖子内容），使用 Pinata 或 Web3.Storage，确保内容上传延迟 < 10 秒

- **FR17：** IPFS 偏好数据管理 - 后端必须提供用户偏好数据的 IPFS 加密存储服务，包括：加密（使用用户钱包签名派生的密钥）、上传到 IPFS、更新哈希到智能合约、下载和解密（需用户签名授权）

- **FR18：** 个性化 Tag 生成服务 - 后端必须分析用户行为数据（点赞的内容主题、互动频率、关注的用户类型），自动生成个性化 Tag（如："DeFi 爱好者"、"政治评论"、"NFT 收藏"），Tag 包含名称、权重、来源说明

- **FR19：** 数据索引服务 - 后端必须使用 The Graph 索引链上数据（用户、内容、Agent、投票记录），提供高效查询 API

- **FR20：** API 网关 - 后端必须提供 RESTful API，供前端调用，包括：用户注册、内容发布、社交互动、Agent 状态查询、偏好管理等

- **FR21：** 链下数据库 - 后端必须使用 PostgreSQL 存储非关键数据（缓存、临时数据、分析指标），与链上数据保持同步

- **FR22：** 任务队列系统 - 后端必须实现任务队列（使用 Redis + Bull），处理异步任务（IPFS 上传、数据同步、Tag 生成、通知发送）

- **FR23：** 监控与日志 - 后端必须集成 Prometheus（指标收集）、Sentry（错误追踪），提供系统健康监控

**Web 前端层（React + Next.js + viem）：**

- **FR24：** 钱包连接登录 - 前端必须支持 MetaMask、WalletConnect 等钱包登录，连接成功率 > 95%

- **FR25：** 用户个人主页 - 前端必须提供用户个人主页，显示头像、简介、发帖历史、关注/粉丝数、信誉评分

- **FR26：** 内容发布功能 - 前端必须提供发布文本内容的界面（≤ 280 字符），提交后显示审核进度（实时状态：等待 Agent 选择 → Agent 审核中 → 共识投票 → 发布成功/拒绝），审核通过后自动显示在时间线

- **FR27：** 社交互动功能 - 前端必须支持关注/取关用户、点赞/取消点赞内容、发表评论（评论也需通过 Agent 审核）

- **FR28：** 时间线展示 - 前端必须提供时间线视图，按时间倒序展示关注用户的最新内容，支持无限滚动加载，每页加载 20 条内容

- **FR29：** 审核结果透明展示 - 用户必须能够点击内容查看审核详情弹窗，显示：参与的 5 个 Agent 信息、各自判断（通过/拒绝）、置信度、最终加权得分、审核时间

- **FR30：** Agent 信誉查询 - 前端必须提供 Agent 列表页面，显示所有 Agent 的：信誉评分、历史判断准确率、质押金额、总审核数量，支持排序和筛选

- **FR31：** DAO 提案与投票界面 - 前端必须提供提案列表页面（显示所有提案、状态、投票进度）、提案详情页面（提案内容、投票选项、当前结果）、投票按钮（需钱包签名）

- **FR32：** 用户通知系统 - 前端必须显示通知中心（新粉丝、内容被点赞/评论、审核结果、DAO 投票提醒），支持未读标记和通知历史

- **FR33：** 响应式设计 - 前端必须支持桌面（1920x1080、1366x768）和移动浏览器（iPhone、Android），页面加载时间 < 3 秒，交互响应 < 500ms

**用户偏好与个性化（IPFS 去中心化实现）：**

- **FR34：** 用户偏好 IPFS 加密存储 - 系统必须将用户行为数据（点赞主题、互动历史、关注偏好）加密后存储到 IPFS，加密密钥由用户钱包签名派生（使用 EIP-712 标准签名），IPFS 哈希记录在智能合约的用户档案中

- **FR35：** 个性化 Tag 自动生成 - 后端服务必须基于用户行为自动生成个性化 Tag（如："DeFi 爱好者"、"政治评论关注者"、"NFT 收藏者"），每个 Tag 包含：Tag 名称、兴趣权重（0-100）、生成来源（基于哪些行为）、生成时间，Tag 数据加密存储在 IPFS

- **FR36：** 我的偏好管理页面 - 前端必须提供"我的偏好"专属页面，显示：

  - 所有自动生成的个性化 Tag（卡片或列表形式）
  - 每个 Tag 的详细信息（名称、权重条、来源说明、生成日期）
  - Tag 删除按钮（每个 Tag 旁边）
  - 总 Tag 数量统计
  - 最后更新时间

- **FR37：** Tag 删除功能 - 用户点击删除按钮后，前端必须：（1）请求用户签名确认；（2）从偏好数据中移除该 Tag；（3）重新加密并上传到 IPFS；（4）更新智能合约中的 IPFS 哈希；（5）刷新页面显示更新后的 Tag 列表

- **FR38：** 偏好数据跨设备同步 - 用户在新设备登录时，前端必须：（1）从智能合约读取用户偏好 IPFS 哈希；（2）从 IPFS 下载加密数据；（3）请求用户签名以解密；（4）恢复所有个性化 Tag 和偏好设置

- **FR39：** Agent 授权访问机制（Phase 2 准备）- 前端必须提供 Agent 授权界面，显示：Agent 名称和信誉、请求访问的数据范围、授权有效期选项（1 天/7 天/30 天/永久），用户签名授权后记录在本地和 IPFS

- **FR40：** 偏好数据导出/导入 - 前端必须提供"导出偏好"按钮（下载加密的 JSON 文件）和"导入偏好"按钮（上传文件并恢复），确保数据可移植性

- **FR41：** 隐私模式 - 前端必须提供"隐私模式"开关，启用后：不生成个性化 Tag、不存储行为数据到 IPFS、仅本地临时存储（会话结束后清除）、在 UI 上显示"隐私模式"标识

- **FR42：** Tag 可视化设计 - Tag 必须使用视觉化方式展示兴趣权重（如：进度条、大小不同的标签云、颜色深浅），让用户直观理解自己的偏好分布

- **FR43：** 多钱包地址关联 - 用户必须能够关联多个钱包地址（主钱包 + 最多 5 个子钱包），系统聚合所有关联钱包的行为数据生成统一的个性化 Tag，前端提供"关联钱包管理"界面，显示所有已关联的地址，支持添加和移除

- **FR44：** Tag 编辑和合并功能 - 用户必须能够：（1）编辑 Tag 名称（自定义显示名称）；（2）合并相似的 Tag（如："DeFi 爱好者" + "DeFi 交易者" → "DeFi 关注者"）；（3）调整 Tag 权重（手动增加/减少兴趣强度）

- **FR45：** 签名说明界面 - 当需要用户签名时（删除 Tag、更新偏好、授权 Agent），前端必须显示清晰的说明弹窗，包含：操作目的、为何需要签名、签名的安全性保证、"我明白了"按钮和"了解更多"链接

- **FR46：** 偏好数据本地缓存机制 - 前端必须在浏览器 IndexedDB 中缓存最新的偏好数据（已解密），当 IPFS 服务不可用时自动使用本地缓存，并显示警告提示："正在使用本地缓存，IPFS 恢复后将同步"

## Non-Functional Requirements（非功能需求）

**性能要求：**

- **NFR1：** 内容审核响应时间必须 < 30 秒（从用户提交到收到审核结果）

- **NFR2：** 单次交易 Gas 费必须 < $0.10（Arbitrum L2）

- **NFR3：** 前端页面首次加载时间必须 < 3 秒，后续页面切换 < 1 秒

- **NFR4：** API 响应时间必须 < 500ms（P95），< 200ms（P50）

- **NFR5：** IPFS 偏好数据上传/下载延迟必须 < 5 秒

- **NFR6：** 系统必须支持 1,000 并发用户（MVP 阶段），10,000 并发用户（6 个月后）

**可靠性要求：**

- **NFR7：** 系统正常运行时间必须 ≥ 99%（月度）

- **NFR8：** IPFS 内容（帖子 + 偏好数据）可访问性必须 ≥ 99%（使用 Pinata 和 Web3.Storage 双备份）

- **NFR9：** 智能合约必须通过第三方安全审计（OpenZeppelin 或 Trail of Bits），无高危和中危漏洞

- **NFR10：** 后端服务必须实现故障自动恢复（Kubernetes 健康检查和自动重启）

- **NFR11：** 用户偏好数据丢失风险必须 < 0.1%（IPFS 双 Pinning + 用户本地备份）

**安全与隐私要求：**

- **NFR12：** 所有 API 必须实现 Rate Limiting（防止 DDoS 攻击），限制：100 请求/分钟/IP

- **NFR13：** 用户偏好数据必须使用 AES-256 加密，加密密钥由用户钱包签名派生（EIP-712 标准），密钥永不存储在服务器或链上

- **NFR14：** 前后端通讯必须使用 HTTPS，智能合约交互必须验证签名

- **NFR15：** 智能合约必须使用多重签名（3/5）控制管理员权限，重大操作必须有时间锁（48 小时）

- **NFR16：** 个性化 Tag 生成逻辑必须在后端执行，前端不得暴露 Tag 生成算法（防止操纵）

- **NFR17：** 用户必须能够完全删除所有偏好数据（IPFS 文件取消 Pin，智能合约哈希清零），符合 GDPR"被遗忘权"

**可扩展性要求：**

- **NFR18：** Agent 服务必须支持水平扩展（通过 Kubernetes Auto-scaling）

- **NFR19：** 数据库必须支持读写分离（PostgreSQL 主从复制）

- **NFR20：** 智能合约设计必须模块化，支持后续升级（使用代理模式或模块化架构）

- **NFR21：** 偏好数据结构必须可扩展，支持 Phase 2 添加新的 Tag 类型（如：内容格式偏好、时间偏好）

- **NFR32：** 单个用户偏好文件大小必须 < 100 KB，超过阈值时自动归档旧数据（保留最近 3 个月行为），确保 IPFS 上传性能和成本可控

**可维护性要求：**

- **NFR22：** 代码必须使用 TypeScript 实现类型安全（前端 + 后端）

- **NFR23：** 智能合约单元测试覆盖率必须 > 90%（使用 Foundry Test）

- **NFR24：** 所有服务必须容器化（Docker），使用 Docker Compose 支持本地开发

- **NFR25：** 代码必须遵循统一的代码规范（ESLint + Prettier for TypeScript，Solhint for Solidity）

**合规要求：**

- **NFR26：** 系统必须符合 GDPR 和 CCPA 要求，提供用户数据导出和删除功能

- **NFR27：** 代币设计必须咨询证券法律师，确保不被认定为证券（符合 Howey Test）

- **NFR28：** 合规规则必须明确禁止违法内容（CSAM、暴力、诈骗），实施自动检测系统

**监控与可观测性：**

- **NFR29：** 系统必须集成 Prometheus + Grafana，监控关键指标（DAU、交易量、Agent 共识率、API 延迟、IPFS 可用性）

- **NFR30：** 所有服务必须输出结构化日志（JSON 格式），集成 ELK Stack 或类似方案

- **NFR31：** 关键业务指标必须实时追踪并可视化（北极星指标：周活跃创作者数 WAC、用户偏好 Tag 生成率）

---
